{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Заказчик</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
        body{min-height:100vh;background:#f8fafc;color:#1e293b;display:flex;flex-direction:column;}
        header{
            background:#ffffff;
            border-bottom:1px solid #e2e8f0;
            box-shadow:0 2px 10px rgba(0,0,0,.05);
            position:sticky;
            top:0;
            z-index:1000;
        }
        .header-container{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:16px 32px;
            max-width:1400px;
            margin:0 auto;
        }
        .logo{
            display:flex;
            align-items:center;
            gap:16px;
        }
        .logo-icon{
            width:48px;
            height:48px;
            background:#10b981;
            border-radius:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-size:24px;
            font-weight:bold;
            box-shadow:0 4px 15px rgba(16,185,129,.3);
        }
        .logo h1{
            font-size:20px;
            font-weight:700;
            color:#1e293b;
        }
        .logo span{
            display:block;
            font-size:13px;
            color:#64748b;
            font-weight:500;
        }
        .top-nav{
            display:flex;
            align-items:center;
            gap:32px;
        }
        .nav-item{
            display:flex;
            align-items:center;
            gap:10px;
            padding:10px 16px;
            border-radius:12px;
            color:#475569;
            font-size:15px;
            font-weight:500;
            cursor:pointer;
            transition:all .2s;
        }
        .nav-item:hover{
            background:#f0fdf4;
            color:#166534;
        }
        .nav-item.active{
            background:#10b981;
            color:#fff;
        }
        .nav-item.active i{color:#fff;}
        .nav-item i{font-size:18px;}
        .user-info{
            display:flex;
            align-items:center;
            gap:12px;
            color:#475569;
            font-size:14px;
        }
        .user-avatar{
            width:40px;
            height:40px;
            background:#10b981;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-weight:600;
            font-size:15px;
        }
        .user-name{font-weight:600;color:#1e293b;}
        .logout-btn{
            background:#ef4444;
            color:#fff;
            border:none;
            padding:10px 20px;
            border-radius:50px;
            font-weight:600;
            cursor:pointer;
            margin-left:20px;
            transition:all .2s;
        }
        .logout-btn:hover{
            background:#dc2626;
        }
        .mobile-menu-btn{
            display:none;
            background:#1e293b;
            color:#fff;
            font-size:20px;
            padding:12px;
            border-radius:8px;
            cursor:pointer;
        }
        main{
            flex:1;
            padding:40px 32px;
            max-width:1400px;
            margin:0 auto;
            width:100%;
        }
        @media(max-width:992px){
            .top-nav{
                display:none;
                flex-direction:column;
                position:absolute;
                top:100%;
                left:0;
                right:0;
                background:#fff;
                border-bottom:1px solid #e2e8f0;
                box-shadow:0 4px 10px rgba(0,0,0,.1);
                padding:16px;
            }
            .top-nav.open{display:flex;}
            .mobile-menu-btn{display:block;}
            .header-container{padding:16px;}
            main{padding:20px;}
        }
        .header-bar{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:32px;
            flex-wrap:wrap;
            gap:16px;
        }
        .page-title{
            font-size:28px;
            font-weight:700;
            color:#1e293b;
        }
        .date-badge{
            background:#e0e7ff;
            color:#4338ca;
            padding:8px 16px;
            border-radius:50px;
            font-size:14px;
            font-weight:500;
        }

        /* АНИМАЦИИ ПЕРЕКЛЮЧЕНИЯ СЕКЦИЙ */
        .section{
            display:none;
            opacity:0;
            transform:scale(0.97) translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .section.active{
            display:block;
            opacity:1;
            transform:scale(1) translateY(0);
        }
        @keyframes fadeInScale {
            from { opacity:0; transform:scale(0.97) translateY(20px); }
            to { opacity:1; transform:scale(1) translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity:1; transform:scale(1); }
            to { opacity:0; transform:scale(0.98); }
        }

        .card{
            background:#fff;
            border-radius:16px;
            padding:28px;
            box-shadow:0 4px 20px rgba(0,0,0,.06);
            border:1px solid #e2e8f0;
            margin-bottom:32px;
        }
        .card-title{
            font-size:20px;
            font-weight:600;
            color:#1e293b;
            margin-bottom:20px;
        }
        .new-order-section .card-title{
            font-size:24px;
            text-align:center;
            margin-bottom:32px;
        }
        .new-order-form{
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
            gap:24px;
        }
        .form-group label{
            display:block;
            margin-bottom:8px;
            color:#475569;
            font-weight:500;
            font-size:14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea{
            width:100%;
            padding:14px 16px;
            border:1px solid #cbd5e1;
            border-radius:12px;
            background:#fff;
            font-size:15px;
            transition:border .2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus{
            outline:none;
            border-color:#10b981;
            box-shadow:0 0 0 3px rgba(16,185,129,.15);
        }
        .form-group textarea{min-height:130px;resize:vertical;}
        .submit-order-btn{
            grid-column:1/-1;
            justify-self:center;
            background:#10b981;
            color:#fff;
            border:none;
            padding:16px 48px;
            border-radius:50px;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            box-shadow:0 6px 20px rgba(16,185,129,.3);
            transition:all .3s;
        }
        .submit-order-btn:hover{
            background:#059669;
            transform:translateY(-2px);
        }
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:24px;}
        .order-card, .passport-card{
            background:#fff;
            border-radius:16px;
            padding:24px;
            box-shadow:0 4px 15px rgba(0,0,0,.05);
            border:1px solid #e2e8f0;
            transition:transform .2s,box-shadow .2s;
        }
        .order-card:hover, .passport-card:hover{
            transform:translateY(-4px);
            box-shadow:0 10px 25px rgba(0,0,0,.1);
        }
        .order-id{font-size:20px;font-weight:700;color:#10b981;margin-bottom:12px;}
        .passport-title{font-size:18px;font-weight:600;color:#1e293b;margin-bottom:12px;}
        .order-item, .passport-item{
            margin-bottom:8px;color:#64748b;font-size:14px;
        }
        .order-status{
            margin-top:16px;
            padding:6px 14px;
            background:#dcfce7;
            color:#166534;
            border-radius:50px;
            display:inline-block;
            font-weight:600;
            font-size:13px;
        }
        .btn{
            margin-top:16px;
            padding:10px 20px;
            border:none;
            border-radius:50px;
            font-weight:600;
            cursor:pointer;
            font-size:14px;
            transition:all .2s;
        }
        .btn-primary{background:#3b82f6;color:#fff;}
        .btn-primary:hover{background:#2563eb;}
        #passport-template{display:none;}
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">СМ</div>
                <div>
                    <h1>Портал заказчика</h1>
                    <span>Система слежения за металлом</span>
                </div>
            </div>

            <nav class="top-nav" id="topNav">
                <div class="nav-item active" data-page="orders"><i class="fas fa-shopping-cart"></i> <span>Мои заказы</span></div>
                <div class="nav-item" data-page="passports"><i class="fas fa-file-alt"></i> <span>Паспорта плавки</span></div>
            </nav>

            <div style="display:flex;align-items:center;gap:20px;">
                <div class="user-info">
                    <div class="user-avatar">{{ request.user.username|slice:":2"|upper }}</div>
                    <div>
                        <div class="user-name">Заказчик</div>
                        <div>{{ request.user.get_full_name|default:request.user.username }}</div>
                    </div>
                </div>

                {% csrf_token %}
                <button class="logout-btn" onclick="logout()">Выход</button>
            </div>

            <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main>
        <!-- МОИ ЗАКАЗЫ -->
        <div class="section active" id="orders">
            <div class="header-bar">
                <h1 class="page-title">Мои заказы</h1>
                <div class="date-badge">Сегодня: {{ current_date }}</div>
            </div>

            <div class="card new-order-section">
                <h2 class="card-title">Оформить новый заказ</h2>
                <form class="new-order-form" onsubmit="handleSubmit(event)">
                    <div class="form-group">
                        <label>Марка стали</label>
                        <select id="steel-grade" required onchange="checkOtherSteel()">
                            <option value="">— Выберите марку стали —</option>
                            <option value="08пс">08пс</option>
                            <option value="08кп">08кп</option>
                            <option value="08Ю">08Ю</option>
                            <option value="Ст3сп">Ст3сп</option>
                            <option value="Ст3пс">Ст3пс</option>
                            <option value="09Г2С">09Г2С</option>
                            <option value="10ХСНД">10ХСНД</option>
                            <option value="17Г1С">17Г1С</option>
                            <option value="20">20</option>
                            <option value="35">35</option>
                            <option value="45">45</option>
                            <option value="40Х">40Х</option>
                            <option value="65Г">65Г</option>
                            <option value="У8А">У8А</option>
                            <option value="У10А">У10А</option>
                            <option value="ШХ15">ШХ15</option>
                            <option value="other">Другая (указать вручную)</option>
                        </select>
                        <input type="text" id="other-steel" placeholder="Укажите марку стали" style="display:none;margin-top:12px;" />
                    </div>

                    <div class="form-group">
                        <label>Количество рулонов</label>
                        <input type="number" min="1" placeholder="Например, 10" required>
                    </div>
                    <div class="form-group">
                        <label>Толщина (мм)</label>
                        <input type="number" step="0.01" placeholder="Например, 1.50" required>
                    </div>
                    <div class="form-group">
                        <label>Ширина (мм)</label>
                        <input type="number" placeholder="Например, 1250" required>
                    </div>
                    <div class="form-group">
                        <label>Вес одного рулона (т)</label>
                        <input type="number" step="0.1" placeholder="Например, 20.5" required>
                    </div>
                    <div class="form-group">
                        <label>Вид обработки</label>
                        <select required>
                            <option value="">— Выберите —</option>
                            <option>Горячекатаный</option>
                            <option>Холоднокатаный</option>
                            <option>Оцинкованный</option>
                            <option>С полимерным покрытием</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Комментарий к заказу</label>
                        <textarea placeholder="Дополнительные пожелания, сроки, особые требования..."></textarea>
                    </div>
                    <button type="submit" class="submit-order-btn">Отправить заказ</button>
                </form>
            </div>

            <div class="card">
                <h3 class="card-title">Текущие заказы</h3>
                <div class="grid">
                    <div class="order-card">
                        <div class="order-id">ЗК-2025-049</div>
                        <div class="order-item">Объём: 85.4 т</div>
                        <div class="order-item">Дата создания: 10.12.2025</div>
                        <div class="order-item">Статус: В производстве</div>
                        <div class="order-status">В процессе</div>
                        <button class="btn btn-primary" onclick="exportOrder('ЗК-2025-049')">Экспорт в Excel</button>
                    </div>
                    <div class="order-card">
                        <div class="order-id">ЗК-2025-048</div>
                        <div class="order-item">Объём: 62.1 т</div>
                        <div class="order-item">Дата создания: 08.12.2025</div>
                        <div class="order-item">Статус: Новый</div>
                        <div class="order-status">Ожидает</div>
                        <button class="btn btn-primary" onclick="exportOrder('ЗК-2025-048')">Экспорт в Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ПАСПОРТА ПЛАВКИ -->
        <div class="section" id="passports">
            <div class="header-bar">
                <h1 class="page-title">Паспорта плавки</h1>
                <div class="date-badge">Сегодня: {{ current_date }}</div>
            </div>

            <div class="card">
                <h3 class="card-title">Доступные паспорта</h3>
                <div class="grid">
                    <div class="passport-card">
                        <div class="passport-title">Паспорт №PL-2025-101</div>
                        <div class="passport-item">Рулон: <strong>RU-2025-060</strong></div>
                        <div class="passport-item">Марка: Ст3сп</div>
                        <div class="passport-item">C: 0.18%, Si: 0.25%, Mn: 0.65%</div>
                        <button class="btn btn-primary" onclick="downloadPassport('PL-2025-101')">Скачать PDF</button>
                    </div>
                    <div class="passport-card">
                        <div class="passport-title">Паспорт №PL-2025-102</div>
                        <div class="passport-item">Рулон: <strong>RU-2025-061</strong></div>
                        <div class="passport-item">Марка: 08пс</div>
                        <div class="passport-item">C: 0.07%, Si: 0.03%, Mn: 0.40%</div>
                        <button class="btn btn-primary" onclick="downloadPassport('PL-2025-102')">Скачать PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ШАБЛОН ДЛЯ PDF -->
    <div id="passport-template">
        <div style="padding:40px;font-family:'Inter',sans-serif;color:#000;background:#fff;width:210mm;height:297mm;box-sizing:border-box;">
            <div style="text-align:center;margin-bottom:40px;">
                <h1 style="font-size:28px;margin:0;">Паспорт качества плавки</h1>
                <h2 style="font-size:24px;margin:10px 0 30px 0;" id="passport-number">Паспорт №PL-2025-101</h2>
            </div>

            <table style="width:100%;border-collapse:collapse;margin-bottom:40px;font-size:14px;">
                <tr>
                    <td style="padding:12px;border:1px solid #000;width:35%;font-weight:bold;background:#f0f0f0;">Номер плавки</td>
                    <td style="padding:12px;border:1px solid #000;" id="melt-number">101245</td>
                </tr>
                <tr>
                    <td style="padding:12px;border:1px solid #000;font-weight:bold;background:#f0f0f0;">Дата плавки</td>
                    <td style="padding:12px;border:1px solid #000;">23 декабря 2025 г.</td>
                </tr>
                <tr>
                    <td style="padding:12px;border:1px solid #000;font-weight:bold;background:#f0f0f0;">Марка стали</td>
                    <td style="padding:12px;border:1px solid #000;" id="steel-mark">Ст3сп</td>
                </tr>
                <tr>
                    <td style="padding:12px;border:1px solid #000;font-weight:bold;background:#f0f0f0;">Химический состав</td>
                    <td style="padding:12px;border:1px solid #000;" id="chem-composition">C: 0.14–0.22%, Si: 0.15–0.30%, Mn: 0.40–0.65%, P ≤ 0.035%, S ≤ 0.040%, Cr ≤ 0.30%, Ni ≤ 0.30%, Cu ≤ 0.30%</td>
                </tr>
                <tr>
                    <td style="padding:12px;border:1px solid #000;font-weight:bold;background:#f0f0f0;">Механические свойства</td>
                    <td style="padding:12px;border:1px solid #000;">Предел текучести σт ≥ 245 МПа<br>Предел прочности σв ≥ 370 МПа<br>Относительное удлинение δ ≥ 26%</td>
                </tr>
                <tr>
                    <td style="padding:12px;border:1px solid #000;font-weight:bold;background:#f0f0f0;">Соответствие стандарту</td>
                    <td style="padding:12px;border:1px solid #000;">ГОСТ 14637-89</td>
                </tr>
            </table>

            <div style="margin-top:60px;display:flex;justify-content:space-between;align-items:end;">
                <div>
                    <p style="margin-bottom:30px;">Контролёр ОТК:</p>
                    <p style="border-top:2px solid #000;width:200px;padding-top:10px;">Кузнецов С.В.</p>
                </div>
                <div style="text-align:right;">
                    <p>Дата выдачи: 25 декабря 2025 г.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Переключение вкладок с анимацией
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.getAttribute('data-page');
                const targetSection = document.getElementById(targetId);
                const currentActive = document.querySelector('.section.active');

                if (currentActive && currentActive.id === targetId) return;

                // Обновляем активный пункт меню
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                if (currentActive) {
                    // Анимация исчезновения
                    currentActive.style.animation = 'fadeOut 0.3s ease forwards';
                    setTimeout(() => {
                        currentActive.classList.remove('active');
                        currentActive.style.animation = '';

                        // Показываем новую секцию с анимацией появления
                        targetSection.classList.add('active');
                        targetSection.style.animation = 'fadeInScale 0.5s ease-out forwards';
                    }, 300);
                } else {
                    targetSection.classList.add('active');
                    targetSection.style.animation = 'fadeInScale 0.5s ease-out forwards';
                }
            });
        });

        function toggleMobileMenu() {
            document.getElementById('topNav').classList.toggle('open');
        }

        function logout() {
            if (confirm('Выйти из системы?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'logout' %}";

                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;

                form.appendChild(csrf);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function checkOtherSteel() {
            const select = document.getElementById('steel-grade');
            const otherInput = document.getElementById('other-steel');
            if (select.value === 'other') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        function handleSubmit(e) {
            e.preventDefault();
            const select = document.getElementById('steel-grade');
            const otherInput = document.getElementById('other-steel');
            let steelGrade = select.value;

            if (steelGrade === 'other') {
                steelGrade = otherInput.value.trim();
                if (!steelGrade) {
                    alert('Пожалуйста, укажите марку стали');
                    return;
                }
            }

            alert(`Заказ успешно отправлен!\nМарка стали: ${steelGrade}\nМы свяжемся с вами для подтверждения.`);
            e.target.reset();
            checkOtherSteel();
        }

        function exportOrder(orderId) {
            const orderData = [
                ["Заказ №", orderId],
                ["Дата создания", "10.12.2025"],
                ["Общий объём", "85.4 т"],
                ["Марка стали", "Ст3сп"],
                ["Количество рулонов", "42"],
                ["Толщина", "1.50 мм"],
                ["Ширина", "1250 мм"],
                ["Вид обработки", "Горячекатаный"],
                ["Статус", "В производстве"],
                ["Комментарий", "Срочный заказ"]
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(orderData);
            ws['!cols'] = [{ wch: 20 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws, "Заказ");
            const fileName = `Заказ_${orderId}_${new Date().toLocaleDateString('ru-RU')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function downloadPassport(passportId) {
            document.getElementById('passport-number').textContent = `Паспорт №${passportId}`;

            if (passportId === 'PL-2025-101') {
                document.getElementById('melt-number').textContent = "101245";
                document.getElementById('steel-mark').textContent = "Ст3сп";
                document.getElementById('chem-composition').textContent = "C: 0.14–0.22%, Si: 0.15–0.30%, Mn: 0.40–0.65%, P ≤ 0.035%, S ≤ 0.040%, Cr ≤ 0.30%, Ni ≤ 0.30%, Cu ≤ 0.30%";
            } else if (passportId === 'PL-2025-102') {
                document.getElementById('melt-number').textContent = "101246";
                document.getElementById('steel-mark').textContent = "08пс";
                document.getElementById('chem-composition').textContent = "C: ≤ 0.10%, Si: ≤ 0.07%, Mn: 0.25–0.50%, P ≤ 0.035%, S ≤ 0.030%, Cr ≤ 0.10%, Ni ≤ 0.10%, Cu ≤ 0.20%";
            }

            const element = document.getElementById('passport-template');

            const opt = {
                margin: [10, 10, 10, 10],
                filename: `${passportId}_паспорт_плавки_${new Date().toLocaleDateString('ru-RU')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>